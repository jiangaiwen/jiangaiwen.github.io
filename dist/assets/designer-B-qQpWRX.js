
    /**
     * 由 Fantastic-admin 提供技术支持
     * Powered by Fantastic-admin
     * Gitee  https://fantastic-admin.gitee.io
     * Github https://fantastic-admin.github.io
     */
    
import{containers as w}from"./widgetsConfig-CgxLr7sx.js";import{G as d,aj as y}from"./index-DGclp6VM.js";import{l as b}from"./lodash.default-CJrNOXdw.js";const C=(m,f)=>{Object.keys(f).forEach(e=>{m[e]=f[e]})};function L(){return{modelName:"formData",refName:"vForm",rulesName:"rules",labelWidth:80,labelPosition:"left",size:"",labelAlign:"label-left-align",cssCode:"",customClass:[],functions:"",layoutType:"PC",jsonVersion:3,onFormCreated:"",onFormMounted:"",onFormDataChange:""}}function W(m){let f=b(L());return{widgetList:[],formConfig:{cssCode:""},selectedId:null,selectedWidget:null,selectedWidgetName:null,vueInstance:m,formWidget:null,cssClassList:[],historyData:{index:-1,maxStep:20,steps:[]},initDesigner(e){this.widgetList=[],this.formConfig=b(f),e||this.initHistoryData()},clearDesigner(e){let t=this.widgetList.length===0;this.widgetList=[],this.selectedId=null,this.selectedWidgetName=null,this.selectedWidget={},C(this.formConfig,f),e||(t?this.saveCurrentHistoryStep():this.emitHistoryChange())},loadPresetCssCode(e){this.formConfig.cssCode===""&&e&&(this.formConfig.cssCode=e)},getLayoutType(){return this.formConfig.layoutType||"PC"},changeLayoutType(e){this.formConfig.layoutType=e},getImportTemplate(){return{widgetList:[],formConfig:deepClone(f)}},loadFormJson(e){let t=!1;return e&&e.widgetList&&(this.formWidget.clearWidgetRefList(),this.widgetList=e.widgetList,t=!0),e&&e.formConfig&&(C(this.formConfig,e.formConfig),t=!0),t&&this.emitEvent("form-json-imported",[]),t},setSelected(e){if(!e){this.clearSelected();return}this.selectedWidget=e,e.id&&(this.selectedId=e.id,this.selectedWidgetName=e.options.name)},updateSelectedWidgetNameAndLabel(e,t,s){this.selectedWidgetName=t,s&&Object.keys(e.options).indexOf("label")>-1&&(e.options.label=s)},clearSelected(){this.selectedId=null,this.selectedWidgetName=null,this.selectedWidget={}},checkWidgetMove(e){if(e.draggedContext&&e.draggedContext.element){let t=e.draggedContext.element.category;if(e.draggedContext.element.type+"",e.to&&e.to.className==="sub-form-table"&&t==="container")return!1}return!0},checkFieldMove(e){if(e.draggedContext&&e.draggedContext.element){e.draggedContext.element.category;let t=e.draggedContext.element.type+"";if(e.to&&e.to.className==="sub-form-table"&&t==="slot")return!1}return!0},appendTableRow(e){let t=e.rows.length,s=deepClone(e.rows[e.rows.length-1]);s.id="table-row-"+d(),s.merged=!1,s.cols.forEach(i=>{i.id="table-cell-"+d(),i.options.name=i.id,i.merged=!1,i.options.colspan=1,i.options.rowspan=1,i.widgetList.length=0}),e.rows.splice(t,0,s),this.emitHistoryChange()},appendTableCol(e){let t=e.rows[0].cols.length;e.rows.forEach(s=>{let i=deepClone(this.getContainerByType("table-cell"));i.id="table-cell-"+d(),i.options.name=i.id,i.merged=!1,i.options.colspan=1,i.options.rowspan=1,i.widgetList.length=0,s.cols.splice(t,0,i)}),this.emitHistoryChange()},insertTableRow(e,t,s,i,l){let o=l?t:t+1;if(!l){let p=o,h=!1;for(;p<e.rows.length;)if(e.rows[p].cols[i].merged)p++;else{o=p,h=!0;break}h||(o=e.rows.length)}let n=deepClone(e.rows[s]);n.id="table-row-"+d(),n.merged=!1,n.cols.forEach(p=>{p.id="table-cell-"+d(),p.options.name=p.id,p.merged=!1,p.options.colspan=1,p.options.rowspan=1,p.widgetList.length=0}),e.rows.splice(o,0,n);let a=0;for(;o<e.rows.length-1&&a<e.rows[0].cols.length;){const p=e.rows[o+1].cols[a];if(p.merged){let c=e.rows,g={},u=null;for(let r=o;r>=0;r--)if(!c[r].cols[a].merged&&c[r].cols[a].options.rowspan>1){u=r,g=c[r].cols[a];break}if(g.options){let r=g.options.rowspan+1;this.setPropsOfMergedRows(e.rows,u,a,g.options.colspan,r),a+=g.options.colspan}else a+=1}else a+=p.options.colspan||1}this.emitHistoryChange()},insertTableCol(e,t,s,i){let l=i?t:t+1;if(!i){let n=l,a=!1;for(;n<e.rows[s].cols.length;){if(e.rows[s].cols[n].merged)n++;else{l=n,a=!0;break}a||(l=e.rows[s].cols.length)}}e.rows.forEach(n=>{let a=deepClone(this.getContainerByType("table-cell"));a.id="table-cell-"+d(),a.options.name=a.id,a.merged=!1,a.options.colspan=1,a.options.rowspan=1,a.widgetList.length=0,n.cols.splice(l,0,a)});let o=0;for(;l<e.rows[0].cols.length-1&&o<e.rows.length;){const n=e.rows[o].cols[l+1];if(n.merged){let p=e.rows[o].cols,h={},c=null;for(let g=l;g>=0;g--)if(!p[g].merged&&p[g].options.colspan>1){c=g,h=p[g];break}if(h.options){let g=h.options.colspan+1;this.setPropsOfMergedCols(e.rows,o,c,g,h.options.rowspan),o+=h.options.rowspan}else o+=1}else o+=n.options.rowspan||1}this.emitHistoryChange()},setPropsOfMergedCols(e,t,s,i,l){for(let o=t;o<t+l;o++)for(let n=s;n<s+i;n++){if(o===t&&n===s){e[o].cols[n].options.colspan=i;continue}e[o].cols[n].merged=!0,e[o].cols[n].options.colspan=i,e[o].cols[n].widgetList=[]}},setPropsOfMergedRows(e,t,s,i,l){for(let o=t;o<t+l;o++)for(let n=s;n<s+i;n++){if(o===t&&n===s){e[o].cols[n].options.rowspan=l;continue}e[o].cols[n].merged=!0,e[o].cols[n].options.rowspan=l,e[o].cols[n].widgetList=[]}},setPropsOfSplitCol(e,t,s,i,l){for(let o=t;o<t+l;o++)for(let n=s;n<s+i;n++)e[o].cols[n].merged=!1,e[o].cols[n].options.rowspan=1,e[o].cols[n].options.colspan=1},setPropsOfSplitRow(e,t,s,i,l){for(let o=t;o<t+l;o++)for(let n=s;n<s+i;n++)e[o].cols[n].merged=!1,e[o].cols[n].options.rowspan=1,e[o].cols[n].options.colspan=1},mergeTableCol(e,t,s,i,l,o){let n=l?i:i+t[i].options.colspan,a=l?i-1:i;if(l){let h=a;for(;h>=0;)if(e[s].cols[h].merged)h--;else{a=h;break}}t[n].widgetList&&t[n].widgetList.length>0&&(!t[a].widgetList||t[a].widgetList.length===0)&&(t[a].widgetList=deepClone(t[n].widgetList));let p=t[n].options.colspan*1+t[a].options.colspan*1;this.setPropsOfMergedCols(e,s,a,p,o.options.rowspan),this.emitHistoryChange()},mergeTableWholeRow(e,t,s,i){let l=e[s].cols[0].options.rowspan,o=!1;for(let a=1;a<e[s].cols.length;a++)if(e[s].cols[a].options.rowspan!==l){o=!0;break}if(o){this.vueInstance.$message.info(this.vueInstance.i18nt("designer.hint.rowspanNotConsistentForMergeEntireRow"));return}let n=t.filter(a=>!a.merged&&!!a.widgetList&&a.widgetList.length>0);n&&n.length>0&&n[0].id!==t[0].id&&(!t[0].widgetList||t[0].widgetList.length<=0)&&(t[0].widgetList=deepClone(n[0].widgetList)),this.setPropsOfMergedCols(e,s,0,t.length,t[i].options.rowspan),this.emitHistoryChange()},mergeTableRow(e,t,s,i,l){let o=i?t:t+l.options.rowspan,n=i?t-1:t;if(i){let p=n;for(;p>=0;)if(e[p].cols[s].merged)p--;else{n=p;break}}e[o].cols[s].widgetList&&e[o].cols[s].widgetList.length>0&&(!e[n].cols[s].widgetList||e[n].cols[s].widgetList.length===0)&&(e[n].cols[s].widgetList=deepClone(e[o].cols[s].widgetList));let a=e[o].cols[s].options.rowspan*1+e[n].cols[s].options.rowspan*1;this.setPropsOfMergedRows(e,n,s,l.options.colspan,a),this.emitHistoryChange()},mergeTableWholeCol(e,t,s,i){let l=e[0].cols[i].options.colspan,o=!1;for(let p=1;p<e.length;p++)if(e[p].cols[i].options.colspan!==l){o=!0;break}if(o){this.vueInstance.$message.info(this.vueInstance.i18nt("designer.hint.colspanNotConsistentForMergeEntireColumn"));return}let n=[];e.forEach(p=>{let h=p.cols[i];!h.merged&&h.widgetList&&h.widgetList.length>0&&n.push(h)});let a=e[0].cols[i];n&&n.length>0&&n[0].id!==a.id&&(!a.widgetList||a.widgetList.length<=0)&&(a.widgetList=deepClone(n[0].widgetList)),this.setPropsOfMergedRows(e,0,i,a.options.colspan,e.length),this.emitHistoryChange()},undoMergeTableCol(e,t,s,i,l){this.setPropsOfSplitCol(e,t,s,i,l),this.emitHistoryChange()},undoMergeTableRow(e,t,s,i,l){this.setPropsOfSplitRow(e,t,s,i,l),this.emitHistoryChange()},deleteTableWholeCol(e,t){let s=!0;if(e.forEach(o=>{o.cols[0].options.colspan!==e[0].cols.length&&(s=!1)}),s){this.vueInstance.$message.info(this.vueInstance.i18nt("designer.hint.lastColCannotBeDeleted"));return}let i=e[0].cols[t].options.colspan,l=!1;for(let o=1;o<e.length;o++)if(e[o].cols[t].options.colspan!==i){l=!0;break}if(l){this.vueInstance.$message.info(this.vueInstance.i18nt("designer.hint.colspanNotConsistentForDeleteEntireColumn"));return}e.forEach(o=>{o.cols.splice(t,i)}),this.emitHistoryChange()},deleteTableWholeRow(e,t){let s=!0;if(e[0].cols.forEach(o=>{o.options.rowspan!==e.length&&(s=!1)}),s){this.vueInstance.$message.info(this.vueInstance.i18nt("designer.hint.lastRowCannotBeDeleted"));return}let i=e[t].cols[0].options.rowspan,l=!1;for(let o=1;o<e[t].cols.length;o++)if(e[t].cols[o].options.rowspan!==i){l=!0;break}if(l){this.vueInstance.$message.info(this.vueInstance.i18nt("designer.hint.rowspanNotConsistentForDeleteEntireRow"));return}e.splice(t,i),this.emitHistoryChange()},getContainerByType(e){let t=[...w,...basicFields,...advancedFields,...customFields],s=null;return t.forEach(i=>{i.category&&i.type&&i.type===e&&(s=i)}),s},getFieldWidgetByType(e){let t=[...w,...basicFields,...advancedFields,...customFields],s=null;return t.forEach(i=>{!i.category&&i.type&&i.type===e&&(s=i)}),s},hasConfig(e,t){let s=null;return e.category?s=this.getContainerByType(e.type):s=this.getFieldWidgetByType(e.type),!s||!s.options?!1:Object.keys(s.options).indexOf(t)>-1},upgradeWidgetConfig(e){let t=null;e.category?t=this.getContainerByType(e.type):t=this.getFieldWidgetByType(e.type),!(!t||!t.options)&&Object.keys(t.options).forEach(s=>{e.hasOwnProperty(s)||(e.options[s]=deepClone(t.options[s]))})},upgradeFormConfig(e){Object.keys(this.formConfig).forEach(t=>{e.hasOwnProperty(t)||(e[t]=deepClone(this.formConfig[t]))})},cloneGridCol(e,t){let s=deepClone(this.getContainerByType("grid-col"));s.options.span=e.options.span;let i=d();s.id="grid-col-"+i,s.options.name="gridCol"+i,t.cols.push(s)},cloneContainer(e){if(e.type==="grid"){let t=deepClone(this.getContainerByType("grid"));return t.id=t.type+d(),t.options.name=t.id,e.cols.forEach(s=>{let i=deepClone(this.getContainerByType("grid-col")),l=d();i.id="grid-col-"+l,i.options.name="gridCol"+l,i.options.span=s.options.span,t.cols.push(i)}),t}else if(e.type==="table"){let t=deepClone(this.getContainerByType("table"));return t.id=t.type+d(),t.options.name=t.id,e.rows.forEach(s=>{let i=deepClone(s);i.id="table-row-"+d(),i.cols.forEach(l=>{l.id="table-cell-"+d(),l.options.name=l.id,l.widgetList=[]}),t.rows.push(i)}),t}else return null},moveUpWidget(e,t){if(e){if(t===0){this.vueInstance.$message(this.vueInstance.i18nt("designer.hint.moveUpFirstChildHint"));return}let s=e[t];e.splice(t,1),e.splice(t-1,0,s)}},moveDownWidget(e,t){if(e){if(t===e.length-1){this.vueInstance.$message(this.vueInstance.i18nt("designer.hint.moveDownLastChildHint"));return}let s=e[t];e.splice(t,1),e.splice(t+1,0,s)}},copyNewFieldWidget(e){let t=deepClone(e),s=d();return t.id=t.type.replace(/-/g,"")+s,t.options.name=t.id,t.options.label=t.options.label||t.type.toLowerCase(),delete t.displayName,t},copyNewContainerWidget(e){let t=deepClone(e);if(t.id=t.type.replace(/-/g,"")+d(),t.options.name=t.id,t.type==="grid"){let s=deepClone(this.getContainerByType("grid-col")),i=d();s.id="grid-col-"+i,s.options.name="gridCol"+i,t.cols.push(s),s=deepClone(s),i=d(),s.id="grid-col-"+i,s.options.name="gridCol"+i,t.cols.push(s)}else if(t.type==="table"){let s={cols:[]};s.id="table-row-"+d(),s.merged=!1;let i=deepClone(this.getContainerByType("table-cell"));i.id="table-cell-"+d(),i.options.name=i.id,i.merged=!1,i.options.colspan=1,i.options.rowspan=1,s.cols.push(i),t.rows.push(s)}else if(t.type==="tab"){let s=deepClone(this.getContainerByType("tab-pane"));s.id="tab-pane-"+d(),s.options.name="tab1",s.options.label="tab 1",t.tabs.push(s)}return delete t.displayName,t},addContainerByDbClick(e){let t=this.copyNewContainerWidget(e);this.widgetList.push(t),this.setSelected(t)},addFieldByDbClick(e){let t=this.copyNewFieldWidget(e);if(this.selectedWidget&&this.selectedWidget.type==="tab"){let s=this.selectedWidget.tabs[0];this.selectedWidget.tabs.forEach(i=>{i.options.active&&(s=i)}),s&&s.widgetList.push(t)}else this.selectedWidget&&this.selectedWidget.widgetList?this.selectedWidget.widgetList.push(t):this.widgetList.push(t);this.setSelected(t),this.emitHistoryChange()},deleteColOfGrid(e,t){e&&e.cols&&e.cols.splice(t,1)},addNewColOfGrid(e){const t=e.cols;let s=deepClone(this.getContainerByType("grid-col")),i=d();if(s.id="grid-col-"+i,s.options.name="gridCol"+i,t&&t.length>0){let l=0;t.forEach(o=>{l+=o.options.span}),l>=24?(console.log("列栅格之和超出24"),e.cols.push(s)):(s.options.span=24-l>12?12:24-l,e.cols.push(s))}else e.cols=[s]},addTabPaneOfTabs(e){const t=e.tabs;let s=deepClone(this.getContainerByType("tab-pane"));s.id="tab-pane-"+d(),s.options.name=s.id,s.options.label="tab "+(t.length+1),t.push(s)},deleteTabPaneOfTabs(e,t){e.tabs.splice(t,1)},emitEvent(e,t){y.$emit(e,t)},handleEvent(e,t){y.$on(e,s=>t(s))},setCssClassList(e){this.cssClassList=e},getCssClassList(){return this.cssClassList},registerFormWidget(e){this.formWidget=e},initHistoryData(){this.loadFormContentFromStorage(),this.historyData.index++,this.historyData.steps[this.historyData.index]={widgetList:deepClone(this.widgetList),formConfig:deepClone(this.formConfig)}},emitHistoryChange(){this.historyData.index===this.historyData.maxStep-1?this.historyData.steps.shift():this.historyData.index++,this.historyData.steps[this.historyData.index]={widgetList:deepClone(this.widgetList),formConfig:deepClone(this.formConfig)},this.saveFormContentToStorage(),this.historyData.index<this.historyData.steps.length-1&&(this.historyData.steps=this.historyData.steps.slice(0,this.historyData.index+1))},saveCurrentHistoryStep(){this.historyData.steps[this.historyData.index]=deepClone({widgetList:this.widgetList,formConfig:this.formConfig}),this.saveFormContentToStorage()},undoHistoryStep(){this.historyData.index!==0&&this.historyData.index--,this.widgetList=deepClone(this.historyData.steps[this.historyData.index].widgetList),this.formConfig=deepClone(this.historyData.steps[this.historyData.index].formConfig)},redoHistoryStep(){this.historyData.index!==this.historyData.steps.length-1&&this.historyData.index++,this.widgetList=deepClone(this.historyData.steps[this.historyData.index].widgetList),this.formConfig=deepClone(this.historyData.steps[this.historyData.index].formConfig)},undoEnabled(){return this.historyData.index>0&&this.historyData.steps.length>0},redoEnabled(){return this.historyData.index<this.historyData.steps.length-1},saveFormContentToStorage(){window.localStorage.setItem("widget__list__backup",JSON.stringify(this.widgetList)),window.localStorage.setItem("form__config__backup",JSON.stringify(this.formConfig))},loadFormContentFromStorage(){let e=window.localStorage.getItem("widget__list__backup");e&&(this.widgetList=JSON.parse(e));let t=window.localStorage.getItem("form__config__backup");t&&C(this.formConfig,JSON.parse(t))}}}export{W as createDesigner};
